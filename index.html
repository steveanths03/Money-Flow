<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unplug ‚Äî Money Flow Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #faf8f3;
    --paper: #fffef9;
    --ink: #1a1a18;
    --muted: #7a7a72;
    --accent: #3a6b8a;
    --accent2: #e8935a;
    --green: #4a8c6a;
    --red: #c0392b;
    --border: #d8d4c8;
    --shadow: rgba(0,0,0,0.08);
  }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--ink); min-height: 100vh; }

  header {
    background: var(--paper);
    border-bottom: 2px solid var(--border);
    padding: 16px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 12px var(--shadow);
  }
  header h1 { font-family: 'Caveat', cursive; font-size: 2rem; font-weight: 700; color: var(--ink); }
  header h1 span { color: var(--accent); }
  .header-total { text-align: right; }
  .header-total .label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); }
  .header-total .value { font-family: 'Caveat', cursive; font-size: 1.7rem; font-weight: 700; }

  .main { display: grid; grid-template-columns: 300px 1fr; min-height: calc(100vh - 68px); }

  /* Sidebar */
  .sidebar {
    background: var(--paper);
    border-right: 2px solid var(--border);
    padding: 20px 18px;
    display: flex;
    flex-direction: column;
    gap: 18px;
    overflow-y: auto;
  }
  .sidebar h3 { font-family: 'Caveat', cursive; font-size: 1.25rem; border-bottom: 1.5px dashed var(--border); padding-bottom: 6px; margin-bottom: 10px; }

  .total-box {
    background: var(--ink); color: white; border-radius: 12px; padding: 18px;
    position: relative; overflow: hidden;
  }
  .total-box::before { content:''; position:absolute; top:-30px;right:-30px; width:100px;height:100px; background:rgba(255,255,255,0.05); border-radius:50%; }
  .total-box .tb-label { font-family:'Caveat',cursive; font-size:1rem; opacity:0.7; margin-bottom:6px; }
  .total-box .tb-amount { font-family:'Caveat',cursive; font-size:2.2rem; font-weight:700; }
  .total-box .tb-edit { display:flex;gap:8px;margin-top:12px; }
  .total-box input { flex:1;background:rgba(255,255,255,0.12);border:1.5px solid rgba(255,255,255,0.25);border-radius:8px;color:white;padding:7px 10px;font-family:'DM Sans',sans-serif;font-size:0.85rem;outline:none; }
  .total-box input::placeholder { color:rgba(255,255,255,0.4); }
  .total-box input:focus { border-color:rgba(255,255,255,0.6); }

  .btn { padding:8px 14px;border:none;border-radius:8px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:500;transition:all 0.15s; }
  .btn-primary { background:var(--accent);color:white; }
  .btn-primary:hover { background:#2d5570;transform:translateY(-1px); }
  .btn-secondary { background:transparent;color:var(--ink);border:1.5px solid var(--border); }
  .btn-secondary:hover { background:var(--bg); }
  .btn-sm { padding:5px 10px;font-size:0.78rem; }

  /* Avatar palette in sidebar */
  .avatar-palette-section { }
  .avatar-category-tabs {
    display: flex; gap: 0; flex-wrap: wrap; margin-bottom: 10px; border: 1.5px solid var(--border); border-radius: 8px; overflow: hidden;
  }
  .acat-tab {
    flex: 1; min-width: 0; padding: 5px 2px; background: transparent; border: none; cursor: pointer;
    font-size: 0.68rem; color: var(--muted); text-align: center; transition: all 0.12s; font-family: 'DM Sans', sans-serif;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .acat-tab.active { background: var(--ink); color: white; }
  .avatar-grid {
    display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px;
    max-height: 200px; overflow-y: auto;
  }
  .avatar-grid::-webkit-scrollbar { width: 4px; }
  .avatar-grid::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  .av-item {
    width: 34px; height: 34px; border-radius: 8px; background: var(--bg);
    border: 2px solid transparent; display: flex; align-items: center; justify-content: center;
    font-size: 1.3rem; cursor: grab; transition: all 0.12s; user-select: none;
    position: relative;
  }
  .av-item:hover { border-color: var(--accent); background: #e8f2f9; transform: scale(1.15); }
  .av-item.selected { border-color: var(--accent); background: #e8f2f9; }
  .av-item[draggable="true"] { cursor: grab; }

  .drag-hint {
    font-size: 0.72rem; color: var(--muted); text-align: center; padding: 6px 0;
    border: 1.5px dashed var(--border); border-radius: 6px; margin-top: 6px;
    font-style: italic;
  }

  /* People list */
  .people-list { display:flex;flex-direction:column;gap:7px;max-height:300px;overflow-y:auto; }
  .people-list::-webkit-scrollbar { width:4px; }
  .people-list::-webkit-scrollbar-thumb { background:var(--border);border-radius:4px; }
  .person-chip { display:flex;align-items:center;gap:9px;padding:9px 10px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;transition:all 0.12s; }
  .person-chip .chip-avatar { font-size:1.4rem;width:34px;height:34px;background:var(--bg);border-radius:50%;display:flex;align-items:center;justify-content:center;border:1.5px solid var(--border); }
  .person-chip .chip-info { flex:1;min-width:0; }
  .person-chip .chip-name { font-weight:500;font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
  .chip-balance { font-size:0.72rem;color:var(--muted); }
  .chip-balance.positive { color:var(--green); }
  .chip-balance.negative { color:var(--red); }

  /* Canvas */
  .canvas-area {
    position: relative; overflow: scroll; background: var(--bg);
    background-image: radial-gradient(circle, #d8d4c8 1px, transparent 1px);
    background-size: 28px 28px;
    overflow-x: scroll; overflow-y: scroll;
  }
  .canvas-area::-webkit-scrollbar { width: 8px; height: 8px; }
  .canvas-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  .canvas-area::-webkit-scrollbar-corner { background: var(--bg); }
  .canvas-area.drag-over { background-color: #f0f6fb; }
  #flow-canvas { position:absolute;top:0;left:0;pointer-events:none;z-index:1; }
  .nodes-container { position:absolute;top:0;left:0;z-index:2; }

  /* Node */
  .node {
    position: absolute; display: flex; flex-direction: column; align-items: center;
    cursor: grab; user-select: none; transition: filter 0.15s;
  }
  .node:active { cursor: grabbing; }
  .node:hover { filter: drop-shadow(0 4px 14px rgba(58,107,138,0.3)); }
  .node-avatar {
    width: 68px; height: 68px; border-radius: 50%; background: #c8e0f0;
    border: 3px solid white; box-shadow: 0 3px 12px var(--shadow), 0 0 0 2px var(--border);
    display: flex; align-items: center; justify-content: center; font-size: 2rem;
    transition: all 0.15s;
  }
  .node-name { font-family:'Caveat',cursive;font-size:1rem;font-weight:600;margin-top:5px;text-align:center;max-width:90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
  .node-card { background:var(--paper);border:2px solid var(--border);border-radius:9px;padding:6px 14px;margin-top:5px;font-family:'Caveat',cursive;font-size:1.3rem;font-weight:700;text-align:center;min-width:90px;box-shadow:2px 2px 0 var(--border);letter-spacing:0.3px; }
  .node-remaining { font-size:0.68rem;color:var(--muted);font-family:'DM Sans',sans-serif;margin-top:2px; }
  .node-card-neg { background: #fff0ee !important; border-color: var(--red) !important; color: var(--red) !important; box-shadow: 2px 2px 0 #f5b8b0 !important; }
  .node-card-zero { background: #f5f5f0 !important; border-color: var(--muted) !important; color: var(--muted) !important; }
  .node-actions { display:flex;gap:3px;margin-top:4px;opacity:0;transition:opacity 0.15s; }
  .node:hover .node-actions { opacity:1; }
  .node-btn { padding:3px 7px;border:1.5px solid var(--border);border-radius:6px;background:var(--paper);font-size:0.7rem;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.12s; }
  .node-btn:hover { background:var(--bg);border-color:var(--accent);color:var(--accent); }
  .node-btn.del:hover { border-color:var(--red);color:var(--red); }

  /* Total node */
  .total-node {
    background:var(--ink);color:white;border-radius:14px;padding:14px 22px;
    box-shadow:4px 4px 0 #444;text-align:center;cursor:grab;min-width:148px;position:absolute;z-index:3;
  }
  .total-node:active { cursor:grabbing; }
  .total-node .tn-label { font-family:'Caveat',cursive;font-size:0.9rem;opacity:0.7; }
  .total-node .tn-amount { font-family:'Caveat',cursive;font-size:1.7rem;font-weight:700; }

  /* Bottom bar */
  .totals-bar {
    position:fixed;bottom:0;left:300px;right:0;background:var(--paper);border-top:2px solid var(--border);
    padding:10px 28px;display:flex;gap:28px;align-items:center;z-index:50;
  }
  .totals-bar .stat { text-align:center; }
  .totals-bar .stat .s-label { font-size:0.68rem;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted); }
  .totals-bar .stat .s-value { font-family:'Caveat',cursive;font-size:1.3rem;font-weight:700; }
  .s-value.green { color:var(--green); }
  .s-value.red { color:var(--red); }

  .canvas-toolbar { position:absolute;top:14px;right:14px;display:flex;gap:7px;z-index:10; }

  /* Empty state */
  .empty-state { position:absolute;top:50%;left:50%;transform:translate(-50%,-60%);text-align:center;pointer-events:none;opacity:0.4; }
  .empty-state .es-icon { font-size:3.5rem;margin-bottom:10px; }
  .empty-state h2 { font-family:'Caveat',cursive;font-size:1.5rem;color:var(--muted); }
  .empty-state p { font-size:0.82rem;color:var(--muted);margin-top:5px; }

  /* Sidebar tabs */
  .sidebar-tabs { display:flex;gap:0;border:1.5px solid var(--border);border-radius:8px;overflow:hidden; }
  .sidebar-tab { flex:1;padding:7px;background:transparent;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:0.8rem;color:var(--muted);transition:all 0.12s;font-weight:500; }
  .sidebar-tab.active { background:var(--ink);color:white; }
  .tab-content { display:none; }
  .tab-content.active { display:block; }

  /* Drop zone overlay hint */
  .drop-overlay {
    position: absolute; inset: 0; display: none; align-items: center; justify-content: center;
    background: rgba(58,107,138,0.05); border: 3px dashed var(--accent); border-radius: 8px;
    z-index: 5; pointer-events: none;
  }
  .drop-overlay.show { display: flex; }
  .drop-overlay span { font-family:'Caveat',cursive;font-size:1.5rem;color:var(--accent); }

  /* Modal */
  .modal-overlay { display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal { background:var(--paper);border:2px solid var(--border);border-radius:16px;padding:24px;min-width:360px;max-width:500px;width:90%;box-shadow:6px 6px 0 var(--border);max-height:90vh;overflow-y:auto; }
  .modal h3 { font-family:'Caveat',cursive;font-size:1.4rem;margin-bottom:14px; }
  .modal .form-row { display:flex;flex-direction:column;gap:4px;margin-bottom:12px; }
  .modal label { font-size:0.72rem;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted);font-weight:500; }
  .modal input,.modal select { padding:8px 11px;border:1.5px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.88rem;background:var(--bg);color:var(--ink);outline:none; }
  .modal input:focus,.modal select:focus { border-color:var(--accent); }
  .modal .btn-row { display:flex;gap:8px;justify-content:flex-end;margin-top:14px; }

  /* Source rows in modal */
  .source-row {
    display:flex;align-items:center;gap:8px;padding:8px 10px;border:1.5px solid var(--border);
    border-radius:8px;background:var(--bg);transition:border-color 0.12s;
  }
  .source-row.active { border-color:var(--accent); background:#f0f6fb; }
  .source-row .sr-emoji { font-size:1.2rem; }
  .source-row .sr-name { flex:1;font-size:0.83rem;font-weight:500; }
  .source-row .sr-avail { font-size:0.68rem;color:var(--muted); }
  .source-row input[type=number] { width:85px;padding:5px 8px;border:1.5px solid var(--border);border-radius:6px;font-size:0.82rem;background:var(--paper); }
  .source-row input[type=number]:focus { border-color:var(--accent); }
  .source-row.disabled input[type=number] { opacity:0.4;pointer-events:none; }

  /* Receiving label */
  .receiving-label {
    font-size:0.78rem;color:var(--muted);background:var(--bg);border:1.5px solid var(--border);
    border-radius:6px;padding:6px 10px;margin-bottom:10px;
    font-style:italic;
  }
  .receiving-label strong { color:var(--green); }

  input[type=number]::-webkit-inner-spin-button { -webkit-appearance:none; }

  /* Sync badge */
  #sync-status { font-size:0.74rem;font-family:'DM Sans',sans-serif;font-weight:500;color:#7a7a72;background:var(--bg);border:1.5px solid var(--border);padding:3px 9px;border-radius:20px; }

  /* Stagger badge on arrows */
  .stagger-badge {
    font-family: 'DM Sans', sans-serif;
    font-size: 9px;
    font-weight: 600;
    fill: white;
  }

  /* ===================== MOBILE ===================== */
  @media (max-width: 700px) {
    header { padding: 10px 14px; }
    header h1 { font-size: 1.4rem; }
    .header-total .value { font-size: 1.2rem; }
    #sync-status { display: none; }

    .main { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }

    .sidebar {
      border-right: none;
      border-bottom: 2px solid var(--border);
      padding: 12px 14px;
      gap: 12px;
      max-height: 42vh;
      overflow-y: auto;
    }
    .sidebar h3 { font-size: 1.1rem; margin-bottom: 6px; }

    .total-box { padding: 12px 14px; }
    .total-box .tb-amount { font-size: 1.6rem; }

    .avatar-grid { grid-template-columns: repeat(8, 1fr); max-height: 110px; }
    .av-item { width: 30px; height: 30px; font-size: 1.1rem; }
    /* On mobile: tap avatar to add, no drag needed */
    .drag-hint { display: none; }
    .tap-hint { display: block !important; }

    .canvas-area {
      height: calc(58vh - 100px);
      min-height: 300px;
    }

    /* node actions always visible on mobile */
    .node-actions { opacity: 1 !important; }

    /* bottom bar full width on mobile */
    .totals-bar {
      left: 0 !important;
      padding: 8px 12px;
      gap: 14px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .totals-bar .stat .s-value { font-size: 1rem; }
    .totals-bar .stat .s-label { font-size: 0.6rem; }

    /* modal full width */
    .modal { min-width: unset; width: 95%; padding: 16px; }

    /* people list taller on mobile since sidebar scrolls */
    .people-list { max-height: none; }

    .canvas-toolbar { top: 8px; right: 8px; }
    .btn-sm { padding: 4px 8px; font-size: 0.74rem; }
  }
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:12px;">
    <h1>Unplug <span>‚ö°</span> Flow</h1>
    <span id="sync-status">‚ü≥ Loading‚Ä¶</span>
  </div>
  <div style="display:flex;align-items:center;gap:10px;">
    <button class="btn btn-secondary btn-sm" onclick="resetAll()" style="opacity:0.7;">üóë Reset</button>
    <div class="header-total">
      <div class="label">Total Received</div>
      <div class="value" id="header-total">‚Çπ0</div>
    </div>
  </div>
</header>

<div class="main">
  <aside class="sidebar">
    <!-- Total Sum -->
    <div>
      <h3>üí∞ Total Sum</h3>
      <div class="total-box">
        <div class="tb-label">Total Sum Received</div>
        <div class="tb-amount" id="total-display">‚Çπ0</div>
        <div class="tb-edit">
          <input type="number" id="total-input" placeholder="Enter amount" />
          <button class="btn btn-primary btn-sm" onclick="setTotal()">Set</button>
        </div>
      </div>
    </div>

    <div class="sidebar-tabs">
      <button class="sidebar-tab active" onclick="switchTab('avatars')">üé≠ Avatars</button>
      <button class="sidebar-tab" onclick="switchTab('people')">üë• People</button>
    </div>

    <!-- Avatars tab -->
    <div class="tab-content active" id="tab-avatars">
      <div class="avatar-category-tabs" id="cat-tabs"></div>
      <div class="avatar-grid" id="avatar-grid"></div>
      <div class="drag-hint">Drag any avatar onto the canvas to add a person</div>
      <div class="tap-hint" style="display:none;font-size:0.72rem;color:var(--muted);text-align:center;padding:6px 0;border:1.5px dashed var(--border);border-radius:6px;margin-top:6px;font-style:italic;">Tap any avatar to add a person</div>
    </div>

    <!-- People tab -->
    <div class="tab-content" id="tab-people">
      <div class="people-list" id="people-list"></div>
    </div>
  </aside>

  <!-- Canvas -->
  <div class="canvas-area" id="canvas-area"
    ondragover="event.preventDefault(); document.getElementById('drop-overlay').classList.add('show');"
    ondragleave="document.getElementById('drop-overlay').classList.remove('show');"
    ondrop="handleCanvasDrop(event)">
    <div class="drop-overlay" id="drop-overlay"><span>Drop here to add person ‚ú¶</span></div>
    <div class="canvas-toolbar">
      <button class="btn btn-secondary btn-sm" onclick="autoLayout()">‚Üî Auto Layout</button>
      <button class="btn btn-secondary btn-sm" onclick="zoomIn()">Ôºã</button>
      <button class="btn btn-secondary btn-sm" id="zoom-label" style="pointer-events:none;min-width:38px;">100%</button>
      <button class="btn btn-secondary btn-sm" onclick="zoomOut()">Ôºç</button>
    </div>
    <div id="canvas-world" style="position:absolute;top:0;left:0;transform-origin:0 0;min-width:2400px;min-height:1600px;">
    <svg id="flow-canvas"></svg>
    <div class="nodes-container" id="nodes-container">
      <div class="empty-state" id="empty-state">
        <div class="es-icon">üó∫Ô∏è</div>
        <h2>Canvas is empty</h2>
        <p>Set a total sum, then drag avatars onto the canvas</p>
      </div>
    </div>
  </div>
</div>

<div class="totals-bar">
  <div class="stat"><div class="s-label">Total Received</div><div class="s-value" id="bar-total">‚Çπ0</div></div>
  <div class="stat"><div class="s-label">Distributed</div><div class="s-value green" id="bar-distributed">‚Çπ0</div></div>
  <div class="stat"><div class="s-label">Unaccounted</div><div class="s-value red" id="bar-unaccounted">‚Çπ0</div></div>
  <div class="stat"><div class="s-label">People</div><div class="s-value" id="bar-people">0</div></div>
</div>

<!-- Add Person Modal (shown on drop) -->
<div class="modal-overlay" id="add-modal">
  <div class="modal">
    <h3>‚ú¶ Add Person</h3>
    <div style="font-size:2.5rem;text-align:center;margin-bottom:12px;" id="add-modal-emoji">üßë</div>
    <div class="form-row">
      <label>Name</label>
      <input type="text" id="add-name" placeholder="Person's name" />
    </div>
    <div class="form-row">
      <label>Receives money from</label>
      <div class="receiving-label">Select who is <strong>sending</strong> money to this person, and enter the amount.</div>
      <div id="add-source-rows" style="display:flex;flex-direction:column;gap:7px;"></div>
    </div>
    <div style="font-size:0.82rem;color:var(--muted);margin-top:4px;">Total receiving: <strong id="add-total-preview">‚Çπ0</strong></div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmAdd()">Add to Flow</button>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <h3>‚úèÔ∏è Edit Person</h3>
    <div class="form-row">
      <label>Name</label>
      <input type="text" id="edit-name" />
    </div>
    <div class="form-row">
      <label>Receiving money from</label>
      <div class="receiving-label">This person is <strong>receiving</strong> money from the sources checked below.</div>
      <div id="edit-source-rows" style="display:flex;flex-direction:column;gap:7px;max-height:280px;overflow-y:auto;"></div>
    </div>
    <div style="font-size:0.82rem;color:var(--muted);margin-top:4px;">Total receiving: <strong id="edit-total-preview">‚Çπ0</strong></div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>

<script>
// ===================== AVATAR CATEGORIES =====================
const AVATAR_CATEGORIES = {
  'People': ['üßë','üë©','üë®','üßî','üë©‚Äçü¶±','üë©‚Äçü¶∞','üë®‚Äçü¶±','üë©‚Äçü¶≥','üë®‚Äçü¶≥','üßï','üë≤','üë≥','üßì','üë¥','üëµ','üßí','üë¶','üëß','üßë‚Äçü¶Ø','üßë‚Äçü¶º','üßë‚Äçü¶Ω','üíÉ','üï∫','üßë‚Äçü§ù‚Äçüßë','üë´','üë¨','üë≠'],
  'Roles': ['üëÆ','üïµÔ∏è','üíÇ','üë∑','üßë‚Äç‚öïÔ∏è','üßë‚Äçüç≥','üßë‚Äçüéì','üßë‚Äçüè´','üßë‚Äçüåæ','üßë‚Äçüîß','üßë‚Äçüè≠','üßë‚Äçüíº','üßë‚Äçüî¨','üßë‚Äçüé®','üßë‚Äç‚úàÔ∏è','üßë‚ÄçüöÄ','üßë‚Äçüöí','ü´Ö','üßô','üßù','üßõ','üßü','üßû','üßú','üßö','ü™Ñ'],
  'Animals': ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','üê¥','ü¶Ñ','üêù','ü¶ã','üêå','üêû','ü¶é','üêä','üê¢','ü¶ñ','ü¶ï'],
  'Fantasy': ['üß∏','ü§ñ','üëæ','üëª','üíÄ','‚ò†Ô∏è','üéÉ','üßø','ü™¨','üí´','‚≠ê','üåü','‚ú®','üåà','ü¶∏','ü¶π','üßú‚Äç‚ôÄÔ∏è','üßö‚Äç‚ôÄÔ∏è','üßô‚Äç‚ôÄÔ∏è','üßù‚Äç‚ôÄÔ∏è','ü™Ñ','üîÆ','üóø','üé≠'],
  'Objects': ['üíé','üí∞','üèÜ','üéØ','üé™','üè†','üöÄ','‚ö°','üåä','üî•','üå∏','üå∫','üåª','üçÄ','üéã','üåø','ü™¥','üçÑ','üçÅ','üçÇ','üå¥','üåµ','üéÑ','üå≤','üå≥'],
  'Faces': ['üòÄ','üòé','ü§ì','ü•∏','ü§©','üòá','ü•≥','üòè','üò§','ü§ë','ü§†','üò∑','ü§ñ','üëΩ','üí©','ü§°','üí™','üß†','üëÅÔ∏è','ü´Ä','ü¶∑','ü¶¥','ü´Å']
};

// ===================== STATE =====================
let totalSum = 0, people = [], nodePositions = {}, totalNodePos = {x:80, y:80}, uid = 1;
let pendingDrop = null;
let editingId = null;
let activeCat = 'People';
let canvasScale = 1;

const SUPABASE_URL = 'https://fwxfrukzqwvpcbeuonlc.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3eGZydWt6cXd2cGNiZXVvbmxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3NjkyNjksImV4cCI6MjA4NzM0NTI2OX0.c1A84hpzHigktiuHg_E0CZmrZGyW9mvjTZj4uF1NzqY';
const STORAGE_KEY = 'unplug_tracker_v2';

let saveTimer = null;
function saveState() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify({totalSum, people, nodePositions, totalNodePos, uid})); } catch(e) {}
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveToSupabase, 800);
}

async function saveToSupabase() {
  try {
    setSyncStatus('saving');
    const payload = {totalSum, people, nodePositions, totalNodePos, uid};
    const res = await fetch(`${SUPABASE_URL}/rest/v1/unplug_state?id=eq.main`, {
      method:'PATCH', headers:{'Content-Type':'application/json','apikey':SUPABASE_KEY,'Authorization':`Bearer ${SUPABASE_KEY}`,'Prefer':'return=minimal'},
      body: JSON.stringify({data: payload, updated_at: new Date().toISOString()})
    });
    if (!res.ok) throw new Error(await res.text());
    setSyncStatus('saved');
  } catch(e) { setSyncStatus('error'); }
}

async function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) { const s = JSON.parse(raw); applyState(s); }
  } catch(e) {}
  try {
    setSyncStatus('loading');
    const res = await fetch(`${SUPABASE_URL}/rest/v1/unplug_state?id=eq.main&select=data`, {
      headers:{'apikey':SUPABASE_KEY,'Authorization':`Bearer ${SUPABASE_KEY}`}
    });
    if (!res.ok) throw new Error();
    const rows = await res.json();
    if (rows.length && rows[0].data && Object.keys(rows[0].data).length) {
      applyState(rows[0].data);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(rows[0].data));
    }
    setSyncStatus('synced'); render();
  } catch(e) { setSyncStatus('error'); }
}

function applyState(s) {
  totalSum = s.totalSum ?? 0; people = s.people ?? [];
  nodePositions = s.nodePositions ?? {}; totalNodePos = s.totalNodePos ?? {x:80,y:80}; uid = s.uid ?? 1;
}

function setSyncStatus(status) {
  const el = document.getElementById('sync-status');
  const m = {loading:{t:'‚ü≥ Syncing‚Ä¶',c:'#7a7a72'},saving:{t:'‚ü≥ Saving‚Ä¶',c:'#7a7a72'},saved:{t:'‚úì Saved',c:'#4a8c6a'},synced:{t:'‚úì Synced',c:'#4a8c6a'},error:{t:'‚úó Offline',c:'#c0392b'}};
  const s = m[status] || m.saved; el.textContent = s.t; el.style.color = s.c;
}

function resetAll() {
  if (!confirm('Reset everything?')) return;
  localStorage.removeItem(STORAGE_KEY);
  totalSum=0; people=[]; nodePositions={}; totalNodePos={x:80,y:80}; uid=1;
  render();
}

function fmt(n) { return '‚Çπ' + Number(n).toLocaleString('en-IN'); }

// ===================== BALANCE HELPERS =====================
function getPersonTotal(id) {
  const p = people.find(x => x.id === id);
  return p ? p.sources.reduce((s, src) => s + src.amount, 0) : 0;
}
function getPersonBalance(id) {
  const total = getPersonTotal(id);
  const given = people.reduce((s,p) => {
    const src = p.sources.find(x => x.srcId === id);
    return s + (src ? src.amount : 0);
  }, 0);
  return total - given;
}
function getAvailableBalance(srcId, excludePersonId = null) {
  if (srcId === 'total') {
    const drawn = people.filter(p => p.id !== excludePersonId).reduce((s,p) => {
      const src = p.sources.find(x => x.srcId === 'total');
      return s + (src ? src.amount : 0);
    }, 0);
    return totalSum - drawn;
  } else {
    const personTotal = getPersonTotal(srcId);
    const drawn = people.filter(x => x.id !== excludePersonId).reduce((s,x) => {
      const src = x.sources.find(y => y.srcId === srcId);
      return s + (src ? src.amount : 0);
    }, 0);
    return personTotal - drawn;
  }
}

// ===================== TOTAL =====================
function setTotal() {
  const v = parseFloat(document.getElementById('total-input').value);
  if (isNaN(v) || v < 0) return;
  totalSum = v;
  document.getElementById('total-input').value = '';
  saveState(); render();
}

// ===================== AVATAR PALETTE =====================
function renderAvatarPalette() {
  const catTabs = document.getElementById('cat-tabs');
  catTabs.innerHTML = '';
  Object.keys(AVATAR_CATEGORIES).forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'acat-tab' + (cat === activeCat ? ' active' : '');
    btn.textContent = cat;
    btn.onclick = () => { activeCat = cat; renderAvatarPalette(); };
    catTabs.appendChild(btn);
  });

  const grid = document.getElementById('avatar-grid');
  grid.innerHTML = '';
  AVATAR_CATEGORIES[activeCat].forEach(emoji => {
    const d = document.createElement('div');
    d.className = 'av-item';
    d.textContent = emoji;
    d.draggable = true;
    d.title = 'Drag to canvas or click to add';

    // --- FIX: use a flag set on dragstart, cleared on dragend ---
    // This avoids the click event firing after a drag ends.
    let isDragging = false;

    d.addEventListener('dragstart', e => {
      isDragging = true;
      e.dataTransfer.setData('emoji', emoji);
      e.dataTransfer.effectAllowed = 'copy';
    });

    d.addEventListener('dragend', () => {
      // Small delay so the click event (which fires before dragend in some browsers) is ignored
      setTimeout(() => { isDragging = false; }, 50);
    });

    d.addEventListener('click', () => {
      if (isDragging) return; // Was a real drag, not a tap
      const canvas = document.getElementById('canvas-area');
      const x = Math.max(40, canvas.scrollLeft + canvas.clientWidth/2 - 40 + (Math.random()-0.5)*120);
      const y = Math.max(40, canvas.scrollTop + canvas.clientHeight/2 - 40 + (Math.random()-0.5)*120);
      openAddModal(emoji, x, y);
    });

    grid.appendChild(d);
  });
}

// ===================== DRAG & DROP TO CANVAS =====================
function handleCanvasDrop(e) {
  e.preventDefault();
  document.getElementById('drop-overlay').classList.remove('show');
  const emoji = e.dataTransfer.getData('emoji');
  if (!emoji) return;
  const canvas = document.getElementById('canvas-area');
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left + canvas.scrollLeft) / canvasScale - 44;
  const y = (e.clientY - rect.top  + canvas.scrollTop)  / canvasScale - 34;
  openAddModal(emoji, Math.max(10, x), Math.max(10, y));
}

// ===================== ADD MODAL =====================
function openAddModal(emoji, x, y) {
  pendingDrop = {emoji, x, y};
  document.getElementById('add-modal-emoji').textContent = emoji;
  document.getElementById('add-name').value = '';

  const container = document.getElementById('add-source-rows');
  container.innerHTML = '';
  buildSourceRows(container, [], null, () => updatePreview('add-total-preview', container));
  updatePreview('add-total-preview', container);

  document.getElementById('add-modal').classList.add('open');
  setTimeout(() => document.getElementById('add-name').focus(), 100);
}

function closeAddModal() {
  document.getElementById('add-modal').classList.remove('open');
  pendingDrop = null;
}

function confirmAdd() {
  if (!pendingDrop) return;
  const name = document.getElementById('add-name').value.trim();
  if (!name) { alert('Please enter a name'); return; }

  const sources = collectSources(document.getElementById('add-source-rows'), null);
  if (!sources) return;
  if (sources.length === 0) { alert('Select at least one source and enter an amount'); return; }

  const id = 'p' + (uid++);
  people.push({id, name, emoji: pendingDrop.emoji, sources});
  nodePositions[id] = {x: pendingDrop.x, y: pendingDrop.y};

  closeAddModal();
  saveState(); render();
}

// ===================== SOURCE ROWS BUILDER =====================
function buildSourceRows(container, existingSources, excludeId, onChange) {
  const allSources = [
    {id:'total', name:'Total Sum', emoji:'üí∞'},
    ...people.filter(p => p.id !== excludeId).map(p => ({id:p.id, name:p.name, emoji:p.emoji}))
  ];

  if (allSources.length === 0 || (allSources.length === 1 && allSources[0].id === 'total' && totalSum === 0)) {
    container.innerHTML = '<div style="color:var(--muted);font-size:0.83rem;padding:8px;">Set total sum first to add sources.</div>';
    return;
  }

  allSources.forEach(src => {
    const existing = existingSources.find(s => s.srcId === src.id);
    const checked = !!existing;
    const curVal = existing ? existing.amount : '';
    const avail = getAvailableBalance(src.id, excludeId);
    const maxAvail = avail + (existing ? existing.amount : 0);

    const row = document.createElement('div');
    row.className = 'source-row' + (checked ? ' active' : '') + (!checked ? ' disabled' : '');
    row.innerHTML = `
      <input type="checkbox" data-srcid="${src.id}" ${checked ? 'checked':''} style="width:16px;height:16px;cursor:pointer;accent-color:var(--accent)">
      <span class="sr-emoji">${src.emoji}</span>
      <span class="sr-name">${src.name}</span>
      <span class="sr-avail">avail: ${fmt(maxAvail)}</span>
      <input type="number" data-amtid="${src.id}" placeholder="‚Çπ" value="${curVal}" min="0" max="${maxAvail}">
    `;

    const cb = row.querySelector('input[type=checkbox]');
    const amt = row.querySelector('input[type=number]');

    cb.addEventListener('change', () => {
      row.classList.toggle('active', cb.checked);
      row.classList.toggle('disabled', !cb.checked);
      if (cb.checked) { amt.focus(); }
      else { amt.value = ''; }
      onChange && onChange();
    });
    amt.addEventListener('input', () => {
      let v = parseFloat(amt.value)||0;
      if (v > maxAvail) { v = maxAvail; amt.value = v; }
      onChange && onChange();
    });

    container.appendChild(row);
  });
}

function collectSources(container, excludeId) {
  const sources = [];
  const checks = container.querySelectorAll('input[type=checkbox]');
  let valid = true;
  checks.forEach(cb => {
    if (!cb.checked) return;
    const srcId = cb.dataset.srcid;
    const amtInput = container.querySelector(`input[data-amtid="${srcId}"]`);
    const amt = parseFloat(amtInput?.value) || 0;
    const avail = getAvailableBalance(srcId, excludeId);
    const existing = excludeId ? people.find(p=>p.id===excludeId)?.sources.find(s=>s.srcId===srcId) : null;
    const maxAvail = avail + (existing ? existing.amount : 0);
    if (amt <= 0 || amt > maxAvail) {
      alert(`Invalid amount for "${srcId === 'total' ? 'Total Sum' : people.find(p=>p.id===srcId)?.name}". Max available: ${fmt(maxAvail)}`);
      valid = false;
    } else {
      sources.push({srcId, amount: amt});
    }
  });
  return valid ? sources : null;
}

function updatePreview(previewId, container) {
  const total = Array.from(container.querySelectorAll('input[type=checkbox]')).reduce((s, cb) => {
    if (!cb.checked) return s;
    const amt = container.querySelector(`input[data-amtid="${cb.dataset.srcid}"]`);
    return s + (parseFloat(amt?.value)||0);
  }, 0);
  document.getElementById(previewId).textContent = fmt(total);
}

// ===================== EDIT =====================
function openEdit(id) {
  editingId = id;
  const p = people.find(x => x.id === id);
  document.getElementById('edit-name').value = p.name;

  const container = document.getElementById('edit-source-rows');
  container.innerHTML = '';
  buildSourceRows(container, p.sources, id, () => updatePreview('edit-total-preview', container));
  updatePreview('edit-total-preview', container);

  document.getElementById('edit-modal').classList.add('open');
}

function closeEditModal() {
  document.getElementById('edit-modal').classList.remove('open');
  editingId = null;
}

function saveEdit() {
  if (!editingId) return;
  const p = people.find(x => x.id === editingId);
  const name = document.getElementById('edit-name').value.trim();
  if (name) p.name = name;

  const sources = collectSources(document.getElementById('edit-source-rows'), editingId);
  if (!sources) return;
  if (sources.length === 0) { alert('At least one source required'); return; }

  p.sources = sources;
  closeEditModal(); saveState(); render();
}

function deletePerson(id) {
  if (!confirm('Remove this person from the flow?')) return;
  people = people.filter(p => p.id !== id);
  people.forEach(p => { p.sources = p.sources.filter(s => s.srcId !== id); });
  delete nodePositions[id];
  saveState(); render();
}

// ===================== RENDER =====================
function render() {
  document.getElementById('header-total').textContent = fmt(totalSum);
  document.getElementById('total-display').textContent = fmt(totalSum);

  const fromTotal = people.reduce((s,p) => {
    const src = p.sources.find(x => x.srcId==='total');
    return s + (src ? src.amount : 0);
  }, 0);

  document.getElementById('bar-total').textContent = fmt(totalSum);
  document.getElementById('bar-distributed').textContent = fmt(fromTotal);
  document.getElementById('bar-unaccounted').textContent = fmt(Math.max(0, totalSum - fromTotal));
  document.getElementById('bar-people').textContent = people.length;

  renderAvatarPalette();
  renderPeopleList();
  renderCanvas();
  applyZoom();

  document.getElementById('empty-state').style.display = (people.length===0 && totalSum===0) ? 'block' : 'none';
}

function renderPeopleList() {
  const el = document.getElementById('people-list');
  el.innerHTML = '';
  people.forEach(p => {
    const total = getPersonTotal(p.id);
    const bal = getPersonBalance(p.id);
    const d = document.createElement('div');
    d.className = 'person-chip';
    d.innerHTML = `
      <div class="chip-avatar">${p.emoji}</div>
      <div class="chip-info">
        <div class="chip-name">${p.name}</div>
        <div class="chip-balance ${bal>=0?'positive':'negative'}">Received: ${fmt(total)} ¬∑ Holds: ${fmt(bal)}</div>
      </div>
    `;
    el.appendChild(d);
  });
}

// ===================== CANVAS / SVG =====================
function renderCanvas() {
  const container = document.getElementById('nodes-container');
  const svg = document.getElementById('flow-canvas');

  Array.from(container.children).forEach(c => { if (!c.id) container.removeChild(c); });
  svg.innerHTML = '';

  const allPos = [totalNodePos, ...Object.values(nodePositions)];
  const maxX = Math.max(2400, ...allPos.map(p => p.x + 300));
  const maxY = Math.max(1600, ...allPos.map(p => p.y + 300));
  const W = maxX, H = maxY;

  svg.setAttribute('width', W); svg.setAttribute('height', H);
  svg.style.width = W + 'px'; svg.style.height = H + 'px';
  container.style.width = W + 'px'; container.style.height = H + 'px';

  if (totalSum > 0 || people.length > 0) renderTotalNode(container);

  const edges = [];
  people.forEach(p => {
    p.sources.forEach(src => {
      edges.push({from: src.srcId, to: p.id, amount: src.amount});
    });
  });

  edges.forEach((edge) => {
    const reverseExists = edges.some(e => e.from === edge.to && e.to === edge.from);
    const isBidirectional = reverseExists;

    let bowSide = 0;
    if (isBidirectional) {
      bowSide = edge.from < edge.to ? 1 : -1;
    }

    const fromCenter = edge.from === 'total' ? getTotalNodeCenter() : getNodeCenter(edge.from);
    const toCenter = edge.to === 'total' ? getTotalNodeCenter() : getNodeCenter(edge.to);
    if (!fromCenter || !toCenter) return;

    drawArrow(svg, fromCenter, toCenter, fmt(edge.amount), isBidirectional, bowSide, edge.from === 'total');
  });

  people.forEach(p => renderPersonNode(container, p));
}

function getTotalNodeCenter() {
  const el = document.querySelector('.total-node');
  if (!el) return {x: totalNodePos.x + 74, y: totalNodePos.y + 50};
  return {x: totalNodePos.x + el.offsetWidth/2, y: totalNodePos.y + el.offsetHeight/2};
}
function getNodeCenter(id) {
  const pos = nodePositions[id];
  if (!pos) return null;
  return {x: pos.x + 44, y: pos.y + 34};
}

function renderTotalNode(container) {
  const avail = getAvailableBalance('total');
  const d = document.createElement('div');
  d.className = 'total-node';
  d.style.left = totalNodePos.x + 'px';
  d.style.top = totalNodePos.y + 'px';
  d.innerHTML = `
    <div class="tn-label">Total Sum Received</div>
    <div class="tn-amount">${fmt(totalSum)}</div>
    <div style="font-size:0.72rem;opacity:0.6;margin-top:3px">Available: ${fmt(avail)}</div>
  `;
  makeDraggable(d, (x,y) => { totalNodePos.x=x; totalNodePos.y=y; });
  container.appendChild(d);
}

function renderPersonNode(container, p) {
  if (!nodePositions[p.id]) nodePositions[p.id] = {x:200, y:200};
  const pos = nodePositions[p.id];
  const total = getPersonTotal(p.id);
  const bal = getPersonBalance(p.id);

  const d = document.createElement('div');
  d.className = 'node';
  d.dataset.id = p.id;
  d.style.left = pos.x + 'px';
  d.style.top = pos.y + 'px';

  d.innerHTML = `
    <div class="node-avatar" title="Click to edit">${p.emoji}</div>
    <div class="node-name">${p.name}</div>
    <div class="node-card ${bal<0?'node-card-neg':bal===0?'node-card-zero':''}">${fmt(bal)}</div>
    <div class="node-remaining" style="color:var(--muted)">received: ${fmt(total)}</div>
    <div class="node-actions">
      <button class="node-btn del" onclick="deletePerson('${p.id}')">üóë remove</button>
    </div>
  `;

  // FIX: pass onTap so clicking (not dragging) the node opens the edit modal
  makeDraggable(d, (x,y) => { nodePositions[p.id].x=x; nodePositions[p.id].y=y; }, (target) => {
    if (!target.closest('.node-actions')) openEdit(p.id);
  });
  container.appendChild(d);
}

// ===================== DRAGGING (mouse + touch) =====================
function makeDraggable(el, onMove, onTap) {
  function doMove(clientX, clientY, ox, oy) {
    const canvas = document.getElementById('canvas-area');
    const cr = canvas.getBoundingClientRect();
    // Account for zoom when computing position
    const nx = (clientX - cr.left - ox + canvas.scrollLeft) / canvasScale;
    const ny = (clientY - cr.top  - oy + canvas.scrollTop)  / canvasScale;
    el.style.left = nx + 'px'; el.style.top = ny + 'px';
    onMove(nx, ny);
    renderCanvas();
  }

  // Mouse
  el.addEventListener('mousedown', e => {
    if (e.target.tagName==='BUTTON' || e.target.tagName==='INPUT') return;
    e.preventDefault();
    const rect = el.getBoundingClientRect();
    const ox = e.clientX - rect.left, oy = e.clientY - rect.top;
    let moved = false;
    const startX = e.clientX, startY = e.clientY;

    const move = ev => {
      if (Math.abs(ev.clientX - startX) > 4 || Math.abs(ev.clientY - startY) > 4) moved = true;
      doMove(ev.clientX, ev.clientY, ox, oy);
    };
    const up = ev => {
      document.removeEventListener('mousemove', move);
      document.removeEventListener('mouseup', up);
      if (!moved && onTap) {
        onTap(ev.target);
      } else if (moved) {
        saveState(); renderCanvas();
      }
    };
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', up);
  });

  // Touch
  el.addEventListener('touchstart', e => {
    if (e.target.tagName==='BUTTON' || e.target.tagName==='INPUT') return;
    e.preventDefault();
    const t = e.touches[0];
    const rect = el.getBoundingClientRect();
    const ox = t.clientX - rect.left, oy = t.clientY - rect.top;
    const startX = t.clientX, startY = t.clientY;
    let moved = false;

    const move = ev => {
      ev.preventDefault();
      const t2 = ev.touches[0];
      if (Math.abs(t2.clientX - startX) > 6 || Math.abs(t2.clientY - startY) > 6) moved = true;
      doMove(t2.clientX, t2.clientY, ox, oy);
    };
    const up = ev => {
      el.removeEventListener('touchmove', move);
      el.removeEventListener('touchend', up);
      if (!moved && onTap) {
        onTap(ev.target);
      } else if (moved) {
        saveState(); renderCanvas();
      }
    };
    el.addEventListener('touchmove', move, {passive: false});
    el.addEventListener('touchend', up);
  }, {passive: false});
}

// ===================== AUTO LAYOUT =====================
function autoLayout() {
  const canvas = document.getElementById('canvas-area');
  const W = canvas.clientWidth;
  totalNodePos = {x: W/2 - 74, y: 40};

  const levels = {}, visited = new Set();

  function assignLevel(id, lvl) {
    if (visited.has(id)) return;
    visited.add(id); levels[lvl] = levels[lvl] || [];
    levels[lvl].push(id);
    people.filter(p => p.sources.some(s => s.srcId === id)).forEach(p => assignLevel(p.id, lvl+1));
  }

  people.filter(p => p.sources.some(s => s.srcId==='total')).forEach(p => assignLevel(p.id, 1));
  people.forEach(p => { if (!visited.has(p.id)) { levels[99] = levels[99]||[]; levels[99].push(p.id); }});

  Object.entries(levels).forEach(([lvl, ids]) => {
    const y = 40 + parseInt(lvl) * 160;
    ids.forEach((id, i) => { nodePositions[id] = {x: (W/(ids.length+1))*(i+1)-44, y}; });
  });

  saveState(); render();
}

// ===================== TABS =====================
function switchTab(tab) {
  document.querySelectorAll('.sidebar-tab').forEach((t,i) => {
    t.classList.toggle('active', (tab==='avatars'&&i===0)||(tab==='people'&&i===1));
  });
  document.getElementById('tab-avatars').classList.toggle('active', tab==='avatars');
  document.getElementById('tab-people').classList.toggle('active', tab==='people');
}

// ===================== SVG ARROWS =====================
function drawArrow(svg, from, to, label, isBidirectional, bowSide, isFromTotal) {
  const color = isFromTotal ? '#2a2a26' : (isBidirectional ? (bowSide < 0 ? '#3a6b8a' : '#b85c20') : '#3a6b8a');
  const strokeW = 2;

  const dx = to.x - from.x, dy = to.y - from.y;
  const dist = Math.sqrt(dx*dx + dy*dy) || 1;
  const nx = -dy / dist, ny = dx / dist;

  const offset = isBidirectional ? bowSide * 28 : 0;
  const fx = from.x + nx * offset, fy = from.y + ny * offset;
  const tx = to.x + nx * offset,   ty = to.y + ny * offset;

  const ddx = tx - fx, ddy = ty - fy;
  const bowPush = isBidirectional ? bowSide * 60 : 0;
  const scx1 = fx + ddx * 0.5 + nx * bowPush;
  const scy1 = fy               + ny * bowPush;
  const scx2 = fx + ddx * 0.5 + nx * bowPush;
  const scy2 = ty               + ny * bowPush;

  const pathD = `M${fx},${fy} C${scx1},${scy1} ${scx2},${scy2} ${tx},${ty}`;

  function cbezPt(t) {
    const mt = 1-t;
    return {
      x: mt*mt*mt*fx + 3*mt*mt*t*scx1 + 3*mt*t*t*scx2 + t*t*t*tx,
      y: mt*mt*mt*fy + 3*mt*mt*t*scy1 + 3*mt*t*t*scy2 + t*t*t*ty
    };
  }
  function cbezLen(steps=30) {
    let len=0, prev=cbezPt(0);
    for(let i=1;i<=steps;i++){const pt=cbezPt(i/steps);const ddx=pt.x-prev.x,ddy=pt.y-prev.y;len+=Math.sqrt(ddx*ddx+ddy*ddy);prev=pt;}
    return len;
  }

  const pathId = 'fp-' + Math.random().toString(36).slice(2, 8);

  const motionPath = document.createElementNS('http://www.w3.org/2000/svg','path');
  motionPath.setAttribute('id', pathId);
  motionPath.setAttribute('d', pathD);
  motionPath.setAttribute('fill', 'none');
  motionPath.setAttribute('stroke', 'none');
  svg.appendChild(motionPath);

  const line = document.createElementNS('http://www.w3.org/2000/svg','path');
  line.setAttribute('d', pathD);
  line.setAttribute('stroke', color);
  line.setAttribute('stroke-width', strokeW);
  line.setAttribute('fill', 'none');
  line.setAttribute('opacity', '0.35');
  svg.appendChild(line);

  const totalLen = cbezLen();
  const dur = Math.max(1.2, totalLen / 120);
  const numArrows = 3;
  const arrowSize = 8;
  const arrowPts = `${arrowSize},0 ${-arrowSize*0.55},${arrowSize*0.55} ${-arrowSize*0.55},${-arrowSize*0.55}`;

  for (let i = 0; i < numArrows; i++) {
    const delay = -(dur * i / numArrows);
    const arrowGroup = document.createElementNS('http://www.w3.org/2000/svg','g');

    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', arrowPts);
    poly.setAttribute('fill', color);
    poly.setAttribute('opacity', '1');
    arrowGroup.appendChild(poly);

    const anim = document.createElementNS('http://www.w3.org/2000/svg','animateMotion');
    anim.setAttribute('dur', `${dur}s`);
    anim.setAttribute('repeatCount', 'indefinite');
    anim.setAttribute('begin', `${delay}s`);
    anim.setAttribute('rotate', 'auto');

    const mpath = document.createElementNS('http://www.w3.org/2000/svg','mpath');
    mpath.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', `#${pathId}`);
    anim.appendChild(mpath);
    arrowGroup.appendChild(anim);
    svg.appendChild(arrowGroup);
  }

  const midPt = cbezPt(0.5);
  const eps = 0.01;
  const pA = cbezPt(0.5 - eps), pB = cbezPt(0.5 + eps);
  let midAngle = Math.atan2(pB.y - pA.y, pB.x - pA.x) * 180 / Math.PI;
  if (midAngle > 90 || midAngle < -90) midAngle += 180;

  const g = document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('transform', `translate(${midPt.x},${midPt.y}) rotate(${midAngle})`);

  const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
  txt.setAttribute('x', '0');
  txt.setAttribute('y', '-9');
  txt.setAttribute('text-anchor', 'middle');
  txt.setAttribute('font-family', 'Caveat, cursive');
  txt.setAttribute('font-size', '15');
  txt.setAttribute('font-weight', '600');
  txt.setAttribute('fill', color);
  txt.setAttribute('opacity', '0.9');
  txt.textContent = label;

  g.appendChild(txt);
  svg.appendChild(g);
}

// ===================== ZOOM =====================
function applyZoom() {
  const world = document.getElementById('canvas-world');
  if (world) world.style.transform = `scale(${canvasScale})`;
  const lbl = document.getElementById('zoom-label');
  if (lbl) lbl.textContent = Math.round(canvasScale * 100) + '%';
}
function zoomIn() {
  canvasScale = Math.min(2, +(canvasScale + 0.15).toFixed(2));
  applyZoom();
}
function zoomOut() {
  canvasScale = Math.max(0.25, +(canvasScale - 0.15).toFixed(2));
  applyZoom();
}

// Pinch-to-zoom on canvas
(function() {
  let lastDist = null;
  const ca = () => document.getElementById('canvas-area');
  document.addEventListener('touchstart', e => {
    if (e.touches.length === 2 && ca().contains(e.target)) lastDist = null;
  });
  document.addEventListener('touchmove', e => {
    if (e.touches.length !== 2 || !ca().contains(e.target)) return;
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if (lastDist !== null) {
      const delta = (dist - lastDist) * 0.005;
      canvasScale = Math.min(2, Math.max(0.25, +(canvasScale + delta).toFixed(3)));
      applyZoom();
    }
    lastDist = dist;
  }, {passive: true});
  document.addEventListener('touchend', e => { if (e.touches.length < 2) lastDist = null; });
})();

// Modal close on outside click
document.getElementById('edit-modal').addEventListener('click', e => { if (e.target===document.getElementById('edit-modal')) closeEditModal(); });
document.getElementById('add-modal').addEventListener('click', e => { if (e.target===document.getElementById('add-modal')) closeAddModal(); });

window.addEventListener('resize', render);
window.onload = () => { loadState(); render(); };
</script>
</body>
</html>